version: '2.2'

x-es_instance: &_es_instance
    image: docker.elastic.co/elasticsearch/elasticsearch:$ES_VERSION
    ulimits:
        memlock:
            soft: -1
            hard: -1
    networks:
        - moloch-elastic


services:
    es01:
        <<: *_es_instance
        container_name: $ES_NODE1
        environment:
            - node.name=$ES_NODE1
            - discovery.seed_hosts=$ES_NODE2,$ES_NODE3
            # default
            - cluster.name=es-moloch-cluster
            - cluster.initial_master_nodes=$ES_NODE1,$ES_NODE2,$ES_NODE3
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms$ES_JAVA_MEM -Xmx$ES_JAVA_MEM"
        volumes:
            - $ES_DATA_DIR/$ES_NODE1:/usr/share/elasticsearch/data
    es02:
        <<: *_es_instance
        container_name: $ES_NODE2
        environment:
            - node.name=$ES_NODE2
            - discovery.seed_hosts=$ES_NODE1,$ES_NODE3
            # default
            - cluster.name=es-moloch-cluster
            - cluster.initial_master_nodes=$ES_NODE1,$ES_NODE2,$ES_NODE3
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms$ES_JAVA_MEM -Xmx$ES_JAVA_MEM"
        volumes:
            - $ES_DATA_DIR/$ES_NODE2:/usr/share/elasticsearch/data
    es03:
        <<: *_es_instance
        container_name: $ES_NODE3
        environment:
            - node.name=$ES_NODE3
            - discovery.seed_hosts=$ES_NODE1,$ES_NODE2
            # default
            - cluster.name=es-moloch-cluster
            - cluster.initial_master_nodes=$ES_NODE1,$ES_NODE2,$ES_NODE3
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms$ES_JAVA_MEM -Xmx$ES_JAVA_MEM"
        volumes:
            - $ES_DATA_DIR/$ES_NODE3:/usr/share/elasticsearch/data

    moloch:
        build:
            context: .
            dockerfile: Dockerfile
        depends_on:
            - $ES_NODE1
            - $ES_NODE2
            - $ES_NODE3
        environment:
            - ES_HOST=$ES_NODE1
            - ES_PORT=9200
        ports:
            - $MOLOCH_PORT:8005
        volumes:
            - moloch_config:/data/config
            - moloch_logs:/data/logs
            - $PCAP_DIR:/data/pcap
        networks:
            - moloch-elastic

volumes:
    moloch_config:
    moloch_logs:


networks:
    moloch-elastic:
